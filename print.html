<!DOCTYPE HTML>
<html lang="zh-CN" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Agora Book - Agora.io 应用开发指南</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="这是一本 Agora 实战应用开发经验集合，总结了作者在开发 NESHouse 和 NESHouse Pro 版本时的心得体会。">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Agora Book - Agora.io 应用开发指南</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/bestony/Agora-Development-Book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="本书介绍"><a class="header" href="#本书介绍">本书介绍</a></h1>
<p><img src="https://postimg.aliavv.com/mbp2021/5s0c3.png" alt="" /></p>
<h2 id="为什么要写这本书"><a class="header" href="#为什么要写这本书">为什么要写这本书？</a></h2>
<p>2021 年初 ClubHouse 的爆火，让 ClubHouse 的音频服务提供商 Agora.io 出现在了大众眼前。每个人开始打量这样的一个公司和他们的产品。作为一个开发者，我开启了一个针对自己的 Hackthon，要用 72 小时完成一个 ClubHouse 的复刻应用的开发。</p>
<p>72 小时过去，不负众望，我成功的开发出来了复刻版的 ClubHouse ，并将其开源出来 ——  <a href="https://github.com/bestony/neshouse">NESHouse</a>。</p>
<p>在开发过程中，我自己觉得声网提供的 SDK 很好用，希望将这个产品介绍给更多的人，也就有了想法，<strong>想要为开发者写一本 Agora.io 的上手指南</strong>。</p>
<p>这本书写于我完成了 NESHouse 和 NESHouse Pro 的第一个版本之后。在完成了两个版本的开发后，我对于 Agora.io 的产品有了更加深入的理解，也有了更多的认识，故而敢试着去写一本电子书，让更多的人可以借此机会了解，并试着使用 Agora.io 来开发出自己的产品。</p>
<h2 id="这本书包含哪些内容"><a class="header" href="#这本书包含哪些内容">这本书包含哪些内容？</a></h2>
<p>Agora.io 的产品不少，有<strong>语音通话</strong>、<strong>视频通话</strong>、<strong>互动直播</strong>、<strong>极速直播</strong>、<strong>实时消息/信令</strong>等，十分的丰富。但就这本电子书而言，自然无法完全覆盖，这本书将聚焦在我更加熟悉的两个服务 <strong>语音通话</strong> 和 <strong>实时消息/信令</strong> 两个方面，如果你希望了解其他产品的信息，则建议你去看 Agora.io 提供的开发者社区和官方文档等信息。</p>
<ul>
<li><a href="https://dev.agora.io/">Agora.io 开发者社区</a></li>
<li><a href="https://rtcdeveloper.com/">Agora.io 讨论组</a></li>
<li><a href="https://docs.agora.io/cn">Agora.io 文档</a></li>
</ul>
<p>此外，受限于我个人的技术能力所限，这本书涉及的技术栈主要是前端领域，后续可能会补充一些我在 Flutter 上的实践。对于其他语言和技术栈的实践，还建议去到上面的三个社区/文档中了解更加专业的信息。</p>
<h2 id="这本书为谁而写"><a class="header" href="#这本书为谁而写">这本书为谁而写？</a></h2>
<p>这本书为那些想要使用 Agora.io 开发一些自己的应用的前端开发者准备。如果你是其他平台的开发者，也可以参考这本书的逻辑，对照 Agora.io 的文档，理解在自己平台中的逻辑实现。</p>
<p>如果给这本书定位，那么这本书应该是一本「<strong>从 0 到 1</strong>」的电子书。</p>
<p>如果你已经准备好了，那就点击左侧的目录，来阅读这本书吧！</p>
<h2 id="license"><a class="header" href="#license">LICENSE</a></h2>
<p><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
<h2 id="备案号"><a class="header" href="#备案号">备案号</a></h2>
<p><a href="https://beian.miit.gov.cn/">京 ICP 备 2022003750 号-5</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="关于作者"><a class="header" href="#关于作者">关于作者</a></h1>
<h2 id="白宦成"><a class="header" href="#白宦成">白宦成</a></h2>
<p>工程师，常年以 ID <em>@bestony</em> 混迹于互联网。喜欢为自己打造工具、自动化、工作流。</p>
<p>个人博客： <a href="https://www.ixiqin.com">https://www.ixiqin.com</a></p>
<h3 id="项目"><a class="header" href="#项目">项目</a></h3>
<p><a href="https://github.com/bestony/neshouse"><strong>NESHouse</strong></a></p>
<p>NesHouse 是一个基于 Agora、LeanCloud 服务，使用 Alpine.js 、Bulma Css、NES.css 构建的前端项目，这个项目实现了一套基于 NES 风格的 clubhouse，你可以使用 NESHouse 来创建自己的线上直播间，也可以将其分享出去，邀请别人一起参与讨论。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="agoraio-的价格"><a class="header" href="#agoraio-的价格">Agora.io 的价格</a></h1>
<h2 id="作为开发者-免费使用"><a class="header" href="#作为开发者-免费使用">作为开发者: 免费使用</a></h2>
<p>Agora.io 为每一位开发者提供了免费的 10,000 分钟的时长，对于开发者来说，你可以大胆的使用 Agora 来完成你的产品测试阶段的开发。赠送的时长对于开发阶段来说，绰绰有余。</p>
<p><img src="https://postimg.aliavv.com/mbp2021/mikk1.png" alt="Agora.io 官网上关于这部分的说明" /></p>
<h2 id="作为产品付费使用有套餐包"><a class="header" href="#作为产品付费使用有套餐包">作为产品：付费使用，有套餐包</a></h2>
<p>和我们熟悉的其他云计算产品不同，Agora.io 的产品计费是按照分钟来计费的，不同的产品的费用会有所不同，但计算方式是一致的。</p>
<p>Agora.io 采用的计算方式是<a href="https://docs.agora.io/cn/All/faq/billing_basis">按频道人数计时</a>，即：<strong>如果频道中有 n 人参与通话 m 分钟，则通话总分钟数 = n * m</strong></p>
<p>举例来说，</p>
<ul>
<li>2 个人视频通话 10 分钟，则通话总时长为 2 * 10 = 20 分钟</li>
<li>5 个人视频通话 10 分钟，则通话总时长为 5 * 10 = 50 分钟</li>
<li>10 个人视频通话 10 分钟，则通话总时长为 10 * 10 = 100 分钟</li>
</ul>
<p>更多的计费方式的说明，你可以参考其官网的<a href="https://www.agora.io/cn/price">价格页面</a>，这里就不再赘述。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="在-web-应用中接入语音通话能力"><a class="header" href="#在-web-应用中接入语音通话能力">在 Web 应用中接入语音通话能力</a></h1>
<p>Agora.io 在其官网文档中有<a href="https://docs.agora.io/cn/Voice/start_call_audio_web_ng?platform=Web">一些基础的说明</a>，但对于一些具体的细节，我认为描述的并不够清楚，因此这里给出一个 MVP 版本的接入指南。</p>
<h2 id="1-安装-sdk"><a class="header" href="#1-安装-sdk">1. 安装 SDK</a></h2>
<p>根据你的开发经验不同，你可以选择使用包管理器安装 Agora 的 SDK， 或者直接加载 CDN 的 JS 文件来快速接入。</p>
<h3 id="11-使用包管理器接入"><a class="header" href="#11-使用包管理器接入">1.1 使用包管理器接入</a></h3>
<p><strong>安装 SDK</strong></p>
<pre><code class="language-bash">npm install agora-rtc-sdk-ng --save
# yarn add agora-rtc-sdk-ng
</code></pre>
<p><strong>在项目中引入依赖文件</strong></p>
<pre><code class="language-js">import AgoraRTC from "agora-rtc-sdk-ng"
</code></pre>
<h3 id="12-使用-cdn-接入"><a class="header" href="#12-使用-cdn-接入">1.2 使用 CDN 接入</a></h3>
<p>使用 CDN 接入相对简单，你只需要将如下代码放在你的项目 HTML 中即可</p>
<pre><code class="language-html">&lt;script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.3.0.js"&gt;&lt;/script&gt;
</code></pre>
<h2 id="2--接入-agora"><a class="header" href="#2--接入-agora">2.  接入 Agora</a></h2>
<p>如下这段代码是接入语音聊天的最简代码，你可以先大体看一下，理解一下逻辑，稍后我们详细讲解其中的一些细节。</p>
<pre><code class="language-js">var rtc = {
  // 用来放置本地客户端。
  client: null,
  // 用来放置本地音频轨道对象。
  localAudioTrack: null,
};

var options = {
  // 替换成你自己项目的 App ID。
  appId: "&lt;YOUR APP ID&gt;",
  // 传入目标频道名。
  channel: "demo_channel_name",
  // 如果你的项目开启了 App 证书进行 Token 鉴权，这里填写生成的 Token 值。
  token: null,
};

async function startBasicCall() {
    
  // 初始化代码逻辑，必需
  rtc.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
  const uid = await rtc.client.join(options.appId, options.channel, options.token, null);
  
  /**
   * 以下逻辑用于订阅频道中的用户音轨，从而可以收听其他用户的声音，必需
   */
  rtc.client.on("user-published", async (user, mediaType) =&gt; {
    // 开始订阅远端用户。
    await rtc.client.subscribe(user, mediaType);
    console.log("subscribe success");

    // 表示本次订阅的是音频。
    if (mediaType === "audio") {
        // 订阅完成后，从 `user` 中获取远端音频轨道对象。
        const remoteAudioTrack = user.audioTrack;
        // 播放音频因为不会有画面，不需要提供 DOM 元素的信息。
        remoteAudioTrack.play();
    }
  });

  /**
   *  以下部分代码用于发布自己的音轨到频道中，一般应用于发言人的逻辑，非必需，根据实际业务需求来完成
   */
  
  // 通过麦克风采集的音频创建本地音频轨道对象。
  rtc.localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
  // 将这些音频轨道对象发布到频道中。
  await rtc.client.publish([rtc.localAudioTrack]);
  console.log("publish success!");

  
}
async function leaveCall() {
  // 销毁本地音频轨道。
  rtc.localAudioTrack.close();

  // 离开频道。
  await rtc.client.leave();
}

startBasicCall();
leaveCall();
</code></pre>
<p>在上述这段代码中，最为核心的是 <em>startBasicCall</em> 中的三块代码，我们按照顺序来看。</p>
<p>第一段代码用于初始化一个 AgoraRTC 的客户端，并使用 Appid、Channel、Token 等信息，加入到频道中，从而获得后续和频道交互的能力。<strong>这部分代码为必需的代码，无论你的应用是什么样的，都首先需要完成初始化，才能进行后续的操作。</strong></p>
<blockquote>
<p>这里的 token 根据你选择的不同的项目鉴权方式，可以选择性的传递。</p>
</blockquote>
<pre><code class="language-js">rtc.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
const uid = await rtc.client.join(options.appId, options.channel, options.token, null);
</code></pre>
<p>第二段代码则是用于订阅频道音频。在实际开发过程中，无论你的业务是什么样的，每一个人一定都需要先订阅频道，收听其他人的声音。因此，这部分代码也需要放在前面，且必需加入相关代码。</p>
<pre><code class="language-js">rtc.client.on("user-published", async (user, mediaType) =&gt; {
    // 开始订阅远端用户。
    await rtc.client.subscribe(user, mediaType);
    console.log("subscribe success");

    // 表示本次订阅的是音频。
    if (mediaType === "audio") {
        // 订阅完成后，从 `user` 中获取远端音频轨道对象。
        const remoteAudioTrack = user.audioTrack;
        // 播放音频因为不会有画面，不需要提供 DOM 元素的信息。
        remoteAudioTrack.play();
    }
  });
</code></pre>
<p>第三段代码则是发布自己的声音，你可以通过下面的两行代码，实现使用麦克风采集音频，并发布到频道中，从而实现让用户说话的能力。这部分功能在实际的业务开发过程中，会根据不同的业务类型，选择性开启，因此，非必需的，这里放在了最后。</p>
<pre><code class="language-js">  // 通过麦克风采集的音频创建本地音频轨道对象。
  rtc.localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
  // 将这些音频轨道对象发布到频道中。
  await rtc.client.publish([rtc.localAudioTrack]);
  console.log("publish success!");
</code></pre>
<h2 id="3-实现你自己的业务逻辑"><a class="header" href="#3-实现你自己的业务逻辑">3. 实现你自己的业务逻辑</a></h2>
<p>当你完成了上述的代码逻辑后，你就实现了在页面中接入 Agora 的功能，接下来你要做的就是实现自己的业务逻辑即可。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="实现用户说话监听"><a class="header" href="#实现用户说话监听">实现用户说话监听</a></h1>
<p>我们在开发应用的时候，会希望标记出哪个用户在发言，这个时候，我们可以通过 Agora 自己提供的 <a href="https://docs.agora.io/cn/Voice/API%20Reference/web_ng/interfaces/iagorartcclient.html#enableaudiovolumeindicator">enableAudioVolumeIndicator</a> 方法来实现该功能。</p>
<p>当你完成初始化后，获得了 RTCClient 的实例后， 就可以在该实例上调用 <code>enableAudioVolumeIndicator</code> 方法，并监听<code>volume-indicator</code>事件，从而获得系统传递的事件。</p>
<pre><code>client.enableAudioVolumeIndicator();
client.on("volume-indicator", volumes =&gt; {
  volumes.forEach((volume, index) =&gt; {
      // 此处可以拿到发言用户的 UID 和 level。
      // 如果 level &gt;= 5 ，则可以视为该用户正在说话
    console.log(`${index} UID ${volume.uid} Level ${volume.level}`);
  });
})
</code></pre>
<p>在使用时，如果你检测到用户的 Level 超过了 5 ，则可以视为该用户正在发言<sup class="footnote-reference"><a href="#level">1</a></sup></p>
<p>在实际使用的时候，需要注意，该事件每 2 秒传递一次数据<sup class="footnote-reference"><a href="#level">1</a></sup>，如果你需要更实时的状态展示，则需要通过其他的方法来完成</p>
<div class="footnote-definition" id="level"><sup class="footnote-definition-label">1</sup>
<p>相关文档见<a href="https://docs.agora.io/cn/Voice/API%20Reference/web_ng/interfaces/iagorartcclient.html#event_volume_indicator">这里</a></p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="实现用户静音"><a class="header" href="#实现用户静音">实现用户静音</a></h1>
<h2 id="使用-setvolume"><a class="header" href="#使用-setvolume">使用 setVolume</a></h2>
<p>在实际的开发过程中，我们会希望设定管理员可以禁言/静音某些用户，这个时候我们就可以借助于 <code>setVolume</code> 来控制麦克风的收音音量，来实现<strong>类似于静音的效果</strong>。</p>
<pre><code class="language-js">// 静音用户
rtc.localAudioTrack.setVolume(0)
// 恢复正常发言
rtc.localAudioTrack.setVolume(100)
</code></pre>
<p>setVolume 的好处是不会重新触发 user-published 事件，相对来说，可以更加实时的表现出静音/取消静音的特质。你可以使用这个功能来完成管理员的强制禁言，或者是用户主动的闭麦。</p>
<h2 id="使用-setenabled"><a class="header" href="#使用-setenabled">使用 setEnabled</a></h2>
<p>如果你认为 setVolume 不够安全，则可以使用 <code>setEnabled</code> 来实现静音的效果。<code>setEnabled</code> 可以将本地的轨道关闭，从而实现完全的停止收音。</p>
<pre><code class="language-js">// 静音用户
rtc.localAudioTrack.setEnabled(false)
// 恢复正常发言
rtc.localAudioTrack.setEnabled(true)
</code></pre>
<p>setEnabled 的好处是可以更加完全的关闭音轨，但坏处是当你开启后，会重新触发 <code>user-published</code> 事件<sup class="footnote-reference"><a href="#setEnable">1</a></sup>，存在一定的延时。</p>
<div class="footnote-definition" id="setEnable"><sup class="footnote-definition-label">1</sup>
<p>相关文档查看<a href="https://docs.agora.io/cn/Voice/API%20Reference/web_ng/interfaces/imicrophoneaudiotrack.html#setenabled">这里</a></p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="错误码"><a class="header" href="#错误码">错误码</a></h1>
<p>Agora.io 的错误码放置在<a href="https://docs.agora.io/cn/Voice/API%20Reference/web_ng/index.html#%E9%80%9A%E7%94%A8%E9%94%99%E8%AF%AF%E7%A0%81">这个页面</a>，你可以在这里搜索</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="在-web-应用中接入实时消息能力"><a class="header" href="#在-web-应用中接入实时消息能力">在 Web 应用中接入实时消息能力</a></h1>
<p>在 Agora.io 官方文档中，给出了一个详细的接入说明，但在我看来，对开发者依然不够友好，因此，这里给出一个 MVP 版本的代码，帮助你快速理解你需要在页面中实现的逻辑。</p>
<h2 id="1-安装-sdk-1"><a class="header" href="#1-安装-sdk-1">1. 安装 SDK</a></h2>
<p>根据你的开发经验不同，你可以选择使用包管理器安装 Agora 的 SDK， 或者直接加载 CDN 的 JS 文件来快速接入。</p>
<h3 id="11-使用包管理器接入-1"><a class="header" href="#11-使用包管理器接入-1">1.1 使用包管理器接入</a></h3>
<p><strong>安装 SDK</strong></p>
<pre><code class="language-bash">npm install agora-rtm-sdk --save
# yarn add agora-rtm-sdk
</code></pre>
<p><strong>在项目中引入依赖文件</strong></p>
<pre><code class="language-js">import AgoraRTM from 'agora-rtm-sdk'
</code></pre>
<h3 id="12-下载-sdk-并接入"><a class="header" href="#12-下载-sdk-并接入">1.2 下载 SDK 并接入</a></h3>
<p>不同于 RTC，Agora 并未给 RTM 提供 CDN 版本的 SDK（<em>这里有点奇怪</em>），因此你需要从<a href="https://docs.agora.io/cn/Real-time-Messaging/downloads">官网下载页面</a>下载最新版 SDK 的 ZIP 包。</p>
<p>解压 ZIP 包后，你可以从项目中提取出 <code>libs/agora-rtm-sdk-x.y.z.js</code> 文件，并将这个文件放置在你的项目中，使用 script 标签引入。</p>
<pre><code class="language-html"> &lt;script src="/path/to/agora-rtm-sdk-1.4.1.js"&gt;&lt;/script&gt;
</code></pre>
<h2 id="2--接入-agora-1"><a class="header" href="#2--接入-agora-1">2.  接入 Agora</a></h2>
<p>如下这段代码是接入实时消息的最简代码，你可以先大体看一下，理解一下逻辑，稍后我们详细讲解其中的一些细节。</p>
<pre><code class="language-js">
/*
 * 初始化客户端
 */
const client = AgoraRTM.createInstance('&lt;APPID&gt;');
// 监听链接状态变化
client.on('ConnectionStateChanged', (newState, reason) =&gt; {
  console.log('on connection state changed to ' + newState + ' reason: ' + reason);
});
// 登陆用户，必需
client.login({ token: '&lt;TOKEN&gt;', uid: '&lt;UID&gt;' }).then(() =&gt; {
  console.log('AgoraRTM client login success');
}).catch(err =&gt; {
  console.log('AgoraRTM client login failure', err);
});

/*
 * 发送点对点消息，非必需
 */
client.sendMessageToPeer(
    { text: 'test peer message' }, // 符合 RtmMessage 接口的参数对象
    '&lt;PEER_ID&gt;', // 远端用户 ID
).then(sendResult =&gt; {
  if (sendResult.hasPeerReceived) {
    /* 远端用户收到消息的处理逻辑 */
  } else {
    /* 服务器已接收、但远端用户不可达的处理逻辑 */
  }
}).catch(error =&gt; {
  /* 发送失败的处理逻辑 */
});
client.on('MessageFromPeer', ({ text }, peerId) =&gt; { // text 为消息文本，peerId 是消息发送方 User ID
  /* 收到点对点消息的处理逻辑 */
});

/*
 * 发送频道消息，非必需
 */
const channel = client.createChannel('&lt;CHANNEL_ID&gt;'); // 此处传入频道 ID
channel.join().then(() =&gt; {
  /* 加入频道成功的处理逻辑 */
}).catch(error =&gt; {
  /* 加入频道失败的处理逻辑 */
});
channel.sendMessage({ text: 'test channel message' }).then(() =&gt; {
  /* 频道消息发送成功的处理逻辑 */
}).catch(error =&gt; {
  /* 频道消息发送失败的处理逻辑 */
});
channel.on('ChannelMessage', ({ text }, senderId) =&gt; { // text 为收到的频道消息文本，senderId 为发送方的 User ID
  /* 收到频道消息的处理逻辑 */
});
channel.leave();

client.logout();
</code></pre>
<p>上述代码中，可以分为三块：初始化、点对点消息、频道消息。</p>
<p><strong>初始化部分</strong>是整个实时消息的基础部分，你需要使用 APPID 来初始化客户端，并登陆用户。</p>
<blockquote>
<p>这里的 token 根据你选择的不同的项目鉴权方式，可以选择性的传递。</p>
</blockquote>
<pre><code class="language-js">const client = AgoraRTM.createInstance('&lt;APPID&gt;');
// 登陆用户，必需
client.login({ token: '&lt;TOKEN&gt;', uid: '&lt;UID&gt;' }).then(() =&gt; {
  console.log('AgoraRTM client login success');
}).catch(err =&gt; {
  console.log('AgoraRTM client login failure', err);
});
</code></pre>
<p><strong>点对点消息</strong>可以根据你的实际业务需求来进行接入，如果不需要相关的功能，则可以不编写此部分的代码。</p>
<pre><code class="language-js">client.sendMessageToPeer(
    { text: 'test peer message' }, // 符合 RtmMessage 接口的参数对象
    '&lt;PEER_ID&gt;', // 远端用户 ID
).then(sendResult =&gt; {
  if (sendResult.hasPeerReceived) {
    /* 远端用户收到消息的处理逻辑 */
  } else {
    /* 服务器已接收、但远端用户不可达的处理逻辑 */
  }
}).catch(error =&gt; {
  /* 发送失败的处理逻辑 */
});
client.on('MessageFromPeer', ({ text }, peerId) =&gt; { // text 为消息文本，peerId 是消息发送方 User ID
  /* 收到点对点消息的处理逻辑 */
});
</code></pre>
<p><strong>频道消息</strong>可以根据你的实际业务需求来进行接入，如果不需要相关的功能，则可以不编写此部分代码</p>
<pre><code class="language-js">const channel = client.createChannel('&lt;CHANNEL_ID&gt;'); // 此处传入频道 ID
channel.join().then(() =&gt; {
  /* 加入频道成功的处理逻辑 */
}).catch(error =&gt; {
  /* 加入频道失败的处理逻辑 */
});
channel.sendMessage({ text: 'test channel message' }).then(() =&gt; {
  /* 频道消息发送成功的处理逻辑 */
}).catch(error =&gt; {
  /* 频道消息发送失败的处理逻辑 */
});
channel.on('ChannelMessage', ({ text }, senderId) =&gt; { // text 为收到的频道消息文本，senderId 为发送方的 User ID
  /* 收到频道消息的处理逻辑 */
});
channel.leave();
</code></pre>
<h2 id="3-实现你自己的业务逻辑-1"><a class="header" href="#3-实现你自己的业务逻辑-1">3. 实现你自己的业务逻辑</a></h2>
<p>当你完成了上述的代码逻辑后，你就实现了在页面中接入 Agora 的功能，接下来你要做的就是实现自己的业务逻辑即可。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="实现信令传递与解析"><a class="header" href="#实现信令传递与解析">实现信令传递与解析</a></h1>
<p>Agora.io 提供的 API 是比较基础的，直接发送文本消息或者是图片消息。对于实际作为控制系统的信令系统，显然是无法满足业务需要的，需要根据自己的实际诉求来设计信令。</p>
<p>根据实际的应用场景，你可以根据你的需要来设计信令，比如我一般使用的有两种。</p>
<ol>
<li><strong>JSON</strong></li>
<li><strong>简单信令</strong></li>
</ol>
<h2 id="json-信令"><a class="header" href="#json-信令">JSON 信令</a></h2>
<p>JSON 信令顾名思义，将信令转换为 JSON 格式，从而方便进行传递和解析，比如，你可以构建这样的函数用于对信令格式化。</p>
<pre><code class="language-js">function encode(id, cmd) {
    return JSON.stringify({
        id, cmd
    })
}
function decode(data) {
    return JSON.parse(data)
}
</code></pre>
<p>则在实际的发送信息和接受消息时，就可以这样处理</p>
<pre><code class="language-js">// 发送信息
channel.sendMessage({ text: encode(userId,"THIS_IS_COMMAND") }).then(() =&gt; {
  /* 频道消息发送成功的处理逻辑 */
}).catch(error =&gt; {
  /* 频道消息发送失败的处理逻辑 */
});

// 接收信息
channel.on('ChannelMessage', ({ text }, senderId) =&gt; { // text 为收到的频道消息文本，senderId 为发送方的 User ID
    const cmd = decode(text)
    // 判断 cmd.cmd 来进行操作。
  /* 收到频道消息的处理逻辑 */
});
</code></pre>
<h2 id="简单信令"><a class="header" href="#简单信令">简单信令</a></h2>
<p>JSON 信令很常用，但问题是在信令传递的过程中，会传递一些无用的数据，比如其间的引号等信息。如果希望信令进一步简化，则可以考虑使用简单信令。</p>
<p>简单信令则是使用不同的符号来切割信令，从而实现最大化的利用信令传递的数据空间。</p>
<p>比如，我们可以定义 <code>,</code> 用于分隔不同的参数;<code>|</code> 用于分隔不同的信令，则我们可以编写这样的函数来构建信令。</p>
<pre><code class="language-js">function encode(id,cmd){
    return cmd + "," + id
}
function decode(cmd){
    return cmd.split(",")
}
</code></pre>
<p>则你可以使用 <code>THIS_IS_COMMAND,1</code> 来替代 JSON 信令中的 <code>{"cmd":"THIS_IS_COMMAND","id":1}</code>，大大的减少了需要传递的信令字符，提升系统的运行效率。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="实现退出时发送信令"><a class="header" href="#实现退出时发送信令">实现退出时发送信令</a></h1>
<p>Agora.io 提供了监听用户退出频道的能力，你只需要监听<code>MemberLeft</code>事件，就可以监听到用户离开。</p>
<p>但<code>MemberLeft</code>事件的触发需要满足以下两者中任一条件：</p>
<ol>
<li>用户调用 leave 方法离开频道</li>
<li>用户由于网络原因与 Agora RTM 系统断开连接达到 30 秒都会触发此回调</li>
</ol>
<p>在 Web 浏览器中，有些时候用户的行为我们是无法监测到的，因此，此行为可能会比较缓慢，如果你希望获得一个更高效，更快的退出显示，则可以考虑组织浏览器退出，并发送退出信令给频道。</p>
<pre><code class="language-js">window.addEventListener("unload", function (event) {
    event.preventDefault();
    event.returnValue = '';
    // 发送退出的信令
});
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="实现超过-512-人的大型房间"><a class="header" href="#实现超过-512-人的大型房间">实现超过 512 人的大型房间</a></h1>
<p>Agroa 的文档中在多处标明，对于 512 人以上的房间，系统的信令将不会触发某些事件，如果你在研发的时候，依赖了该事件，则可能会出现这个问题。</p>
<p><img src="https://postimg.aliavv.com/mbp2021/3gw1z.png" alt="" /></p>
<p>如果想要避免这个问题，则可以考虑通过<strong>自建信令的机制</strong>，来避免对官方事件的依赖，你只需要在用户触发相应的事件的时候，直接发送相应的信令，来完成该能力的触发。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="实现显示用户人数"><a class="header" href="#实现显示用户人数">实现显示用户人数</a></h1>
<p>Agroa.io 提供了 <a href="https://docs.agora.io/cn/Real-time-Messaging/API%20Reference/RTM_web/classes/rtmclient.html#getchannelmembercount">getChannelMemberCount</a> 方法来获取频道中的人数。</p>
<p>不过，你也可以通过监听 <a href="https://docs.agora.io/cn/Real-time-Messaging/API%20Reference/RTM_web/interfaces/rtmevents.rtmchannelevents.html#membercountupdated">MemberCountUpdated</a> 事件来获得频道内的用户人数。后者在频道成员人数 ≤ 512 时，触发频率为每秒 1 次；频道成员人数超过 512 时，触发频率为每 3 秒 1 次。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="一些需要注意的点"><a class="header" href="#一些需要注意的点">一些需要注意的点</a></h1>
<p>在实际开发过程中，有一些特殊的点，可能需要你注意一下，它可能和你设想的不太一样。</p>
<h2 id="用户属性"><a class="header" href="#用户属性">用户属性</a></h2>
<p><img src="https://postimg.aliavv.com/mbp2021/40ovp.png" alt="" /></p>
<p>用户属性只能一个个获取，你无法批量获取用户属性，因此，你无法使用它来存储用户的头像、昵称等信息。getMembers 也无法获取到这个属性，你只能获取到用户 ID 的数组。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="关于项目"><a class="header" href="#关于项目">关于项目</a></h1>
<h2 id="为什么你需要创建多个项目"><a class="header" href="#为什么你需要创建多个项目">为什么你需要创建多个项目？</a></h2>
<p>Agora.io 中的数据，是以项目为单位来进行组织的，不同的项目，会有不同的 AppID ，在进行计费的时候，也会分配到不同的项目中。</p>
<p>如果你需要在不同的项目中使用 Agora.io 的服务，则建议你创建多个 Project，从而可以更好的区分不同的项目的用量。</p>
<h2 id="项目的不同鉴权方式影响了什么"><a class="header" href="#项目的不同鉴权方式影响了什么">项目的不同鉴权方式影响了什么？</a></h2>
<p>Agora.io 的 Project 在创建的时候，会让你选择具体的鉴权模式，你可以选择 <strong>APPID</strong> 或者 <strong>APPID + Token</strong> 的限制。前者只需要一个 APPID，就可以连接上声网的服务器，而后者则需要 APP ID 和来自服务端计算的 Token 才能连接上声网的服务器。</p>
<p>相比之下，后者更加安全（因为需要两个因素，且第二个因素来自访问者不可控的服务端），但相应的，后者也存在自己的实现成本问题，你需要在自己的服务端中实现相应的 Token 算法。</p>
<p>更多关于用户校验的说明，你可以参考<a href="https://docs.agora.io/cn/Interactive%20Broadcast/token?platform=Web">这个文档</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="反馈"><a class="header" href="#反馈">反馈</a></h1>
<h2 id="电子书勘误"><a class="header" href="#电子书勘误">电子书勘误</a></h2>
<p>关于这本书的任何勘误、补充等信息，你可以选择通过 <a href="https://github.com/bestony/Agora-Development-Book">Github</a> 提交 PR 。</p>
<h2 id="联系作者"><a class="header" href="#联系作者">联系作者</a></h2>
<p>你可以<a href="mailto:bestony@linux.com">发邮件</a>给我，我的邮箱是 bestony@linux.com</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>


        <!-- Google Analytics Tag -->
        <script>
            var localAddrs = ["localhost", "127.0.0.1", ""];

            // make sure we don't activate google analytics if the developer is
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'G-N2MS64YPM9', 'auto');
                ga('send', 'pageview');
            }
        </script>


        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
